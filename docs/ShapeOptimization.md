# ParaBlade

## Shape Optimization
This document will help you set up your first shape-optimization routine in ParaBlade using SU2.

### Pre-requisite
To start the optimization procedure you need the following files:   
   
1. **SU2_CONFIG_FILE:**    
 One of the main files requried for running optimization is the SU2_Config file. Some necessary options that should be mentioned in SU2_Config file for CAD Optimization are:
 ```
 OBJECTIVE_FUNCTION =<YOUR OBJECTIVE FUNCTION>   
 
 DV_KIND= SURFACE_FILE   
 
 MOTION_FILENAME = MoveSurface.txt  
 
 VISUALIZE_DEFORMATION= YES   
 
 MARKER_MOVING = (wall1) # Name of the surface to be moved (e.g. BLADE or wall1)
 
 DV_MARKER= ( wall1 )   # Name of the surface to be moved (e.g. BLADE or wall1)
 
 DV_PARAM= ( 1, 0.5 )
    
 DV_VALUE= 0.001
    
 MARKER_DEFORM_TANGENTIAL= ( HUB, SHROUD ) # Optional: see special note on mesh deformation below
 
 MARKER_DEFORM_NORMAL = ( PER1, PER2 ) # Optional: see special note on mesh deformation below
  ``` 

Furthermore, the user should tweak the `CFL` and `EXT_ITER` such that for the case under investigation has a monotonic convergence for direct and adjoint solver for the BASE MESH.
    
2. **PARABLADE_CONFIG_FILE:**   
 The user should provide a PARABLADE_CONFIG which represents the surface of the blade in BASE_MESH with an R-square value of 0.95 (accuracy).
   
3. **OPTIMIZATION CONFIG FILE:**   
 The user should provide a Optimization Config file which consists of for eg: Optimization Mode, Objective, Constrain and Relaxation factor values to perform optimization. A more extensive explanation of the structure of this file can be found [here](/docs/OptimizationCfg.md).
    See sample [file](/TestCases/ShapeOptimization/Optimization_template.cfg).
    
4. **BASE MESH:**   
 The user should provide with a Base Mesh file for optimization for which the above mentioned configuration files are applicable.
   
5. **MAPPING OF BASE MESH SURFACE:**   
 The user should also provide with a blade matching file of the following format:   
 ```   
 "VARIABLES" = "Point", "x_coord" , "y_coord" , "z_coord" , "u" , "v"
    
    xxx, xxx, xxx, xxx, xxx, xxx,
        
    xxx, xxx, xxx, xxx, xxx, xxx,
       
    xxx, xxx, xxx, xxx, xxx, xxx,
  ``` 
where, Point is the global index of the surface mesh point, coords are the orginal cordinate values of the surface as in BASE MESH and uv are the NURBS parameter identifying the point location on the NURBs curve.

Look at the example [file](/TestCases/ShapeOptimization/Aachen_match.csv).

This file can be generated by using the MatchBlade functionality of the ParaBlade.

### Gradient Validation:   
Before running any shape optimization, the gradients of the objective function and constrain (if any) from Adjoint should be validated against finite difference. In order to do this the ShapeOptimization Class is capable of performing adjoint Sensitivity calculation independent of optimization and Finite Difference in 1ST  and 2ND Order.

#### Discrete Adjoint:   
For discrete adjoint just run the Optimization code with:
```   
OPERATION_TYPE = DISCRETE_ADJOINT
```   
in the Optimization configuration file. This would generate a of_grad_adj.dat file in DISCRETE_ADJOINT folder containing the sensitivity of your objective function.

#### Finite Difference:
Simillarly, for finite difference run optimization with
```    
OPERATION_TYPE = FINITE_DIFFERENCE
```   
in the Optimization configuration file. This would generate of_grad_diff.dat file in FINDIFF folder containing the sensitivity of your objective function.

### Shape Optimization:
Once the Gradient from Finite Difference and Adjoint match one another accurately, you can run the shape optimization using the same optimization configuration file but with option
```    
OPERATION_TYPE = SHAPE_OPTIMIZATION
```

### Test Case 

#### 2D:

#### Quasi-3D:

#### Full-3D:

** Special notes **

##### Mesh deformation 

Mesh deformation, specially in 3D cases, can be one of the bottlenecks of the shape optimization. Therefore, it is very
important of take care of the surfaces that should and should not be moved during this operation.

The mesh deformation algorithm implemented in ``SU2_DEF`` incorporates some options for keeping some surfaces away from deforming in the tangential/normal direction. Especially in axial 3D cases, it has been noticed that the hub and shroud surfaces can move upwards (or downwards) in the radial direction. The same can happen in radial test cases where the blade surfaces can move in the normal direction of the hub and shroud. The following options can be set in the configuration file to avoid this kind of problems:

- ``MARKER_DEFORM_TANGENTIAL = ( HUB, SHROUD )``: the surfaces included in this marker will deform **only** in the 
tangential direction.

- ``MARKER_DEFORM_NORMAL = ( SURFACE )``: the surfaces included in this marker will **not** deform in the normal direction.

**NOTE**: currently, this capabilities are only implemented in ``SU2/feature_turbo_ffd``.  

It has been also observed that for very fine meshes ``SU2_DEF`` can struggle in achieving a substantial reduction in the residuals. Some parameters that have been tested and help in the mesh deformation converged are the following:

- ``DEFORM_COEFF``: by default set to ``1E6``, however bigger values (e.g. ``1E8``) or smaller (e.g. ``0.5`` or even negative such as ``-0.2``) have been helpful for the test cases included in the folders.

- ``DEFORM_STIFFNESS_TYPE``: for meshes with boundary layer refinement, ``WALL_DISTANCE`` is recommended. However, ``INVERSE_VOLUME`` can also be tried in case that the former does not produce good quality meshes.

- ``DEFORM_LINEAR_SOLVER``: by default, ``FGMRES`` is selected. It is recommended its use, however if the residual convergence is not enough others such as ``RESTARTED_FGMRES`` can be employed as it allows more linear iterations to be run.

- ``DEFORM_LINEAR_ITER``: in 3D problems it is recommended to use the maximum allowed for ``FGMRES`` (1000 due to memory restrictions), but in case of other linear solvers the convergence of the residuals should be checked and a greater value could be selected accordingly.

##### Discrete adjoint solver convergence

In order to achieve a smooth convergence in the discrete adjoint solver in ``SU2_CFD_AD``, the flow residuals have to be as smooth as possible, especially taking care of not having big oscillations towards the final iterations of the CFD simulation.

Some options that can be employed in the direct run to try and have smooth residuals are:

- ``CFL_NUMBER``: for fine meshes it is recommended to use a low value (e.g. 1) 

- ``CFL_REDUCTION_TURB``

- ``RELAX_FACTOR_FLOW`` and ``RELAX_FACTOR_TURB``: lowering the relaxation factor can ease the convergence (e.g. ``0.8``)

- ``SLOPE_LIMITER_FLOW``

- ``CONV_NUM_METHOD_FLOW``: ``ROE`` is recommended, however ``JST`` has been found useful in some test cases.



*Author: Nitish Anand, Pablo Garrido de la Serna*
